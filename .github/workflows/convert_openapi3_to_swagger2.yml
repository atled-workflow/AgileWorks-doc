name: Convert OpenAPI3 to Swagger2 and Deploy Swagger UI

on:
  push:
    branches: [ "main" ]
    paths:
      -  'api/**'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  convert_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # 変更されたディレクトリを取得
      - name: Detect changed directory
        id: detect_changes
        run: |
          # 変更されたファイルの中で openapi.yaml を含むディレクトリを取得
          CHANGED_FILE=$(git diff --name-only HEAD~1 HEAD | grep 'openapi.yaml' || echo "")
          if [ -z "$CHANGED_FILE" ]; then
            echo "No openapi.yaml changes detected."
            exit 1
          fi
          CHANGED_DIR=$(dirname "$CHANGED_FILE")
          echo "Changed directory: $CHANGED_DIR"
          echo "changed_dir=$CHANGED_DIR" >> $GITHUB_ENV

      # node_modules のインストールをキャッシュする
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: '**/node_modules'
          key: node-modules-${{ hashFiles('**/package-lock.json') }}

      # 必要な依存関係をインストール
      - name: Install dependencies
        run: npm ci

      # OpenAPI3 ドキュメントをフラット化
      - name: Flatten the OpenAPI3 document
        run: |
          npx openapi-flattener -s ${{ env.changed_dir }}/openapi.yaml -o ${{ env.changed_dir }}/openapi_flat.yaml

      # OpenAPI3 から Swagger2 へ変換
      - name: Convert OpenAPI3 to Swagger2
        run: |
          npx api-spec-converter --from=openapi_3 --to=swagger_2 --syntax=yaml ${{ env.changed_dir }}/openapi_flat.yaml > ${{ env.changed_dir }}/swagger.yaml

      # 変換したファイルをコミットしてプッシュ
      - name: Commit and Push changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add ${{ env.changed_dir }}/swagger.yaml
          git commit -m "Convert OpenAPI3 to Swagger2 in ${{ env.changed_dir }}" || echo "No changes to commit"
          git push origin main

      # Swagger UI ファイルをチェックアウトして必要なものをコピー
      - name: Checkout swagger-ui
        uses: actions/checkout@v4
        with:
          repository: swagger-api/swagger-ui
          ref: 'v4.15.5'
          path: swagger-ui
          sparse-checkout: dist

      - name: Inject Swagger static files
        run: cp -n ./swagger-ui/dist/* ${{ env.changed_dir }}/

      # GitHub Pages 用にビルドしてデプロイ
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ${{ env.changed_dir }}/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
